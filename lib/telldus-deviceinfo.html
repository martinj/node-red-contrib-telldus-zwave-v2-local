<script type="text/javascript">
    RED.nodes.registerType('telldus-deviceinfo',{
        category: 'Telldus',
        color: '#FFFFFF',
        defaults: {
            gateway: { type:"telldus-gateway", required:true },
            localId: { value:0, validate:RED.validators.number(), required:true },
            name: {value:""}
        },
        icon: "telldusicon.png",
        align: 'left',
        paletteLabel: "device-info",
        inputs:1,
        outputs:1,
        label: function() {
            return this.name||"device-info";
        },
        oneditprepare: function() {
            try {
                $("#node-input-localId").autocomplete( "destroy" );
            } catch(err) { }

            $.getScript('telldus-local/common')
                .done(function(data, textStatus, jqxhr) {

                    $("#node-lookup-localId").click(function() {
                        var configNodeId = $("#node-input-gateway").val();

                        if (configNodeId != '_ADD_')
                            telldusCommon.search(configNodeId, getDevices)
                    });

                    $("#node-input-gateway").on('change', function() {
                        telldusCommon.enableOrDisableForm(this.value);
                    });
                });
        }
    });

    async function getDevices(configuration) {

        var url ='devices/' + configuration.ip + '/' + configuration.accessToken;

        await $.getJSON(url,function(data) {
                $("#node-lookup-localId-icon").addClass('fa-search');
                $("#node-lookup-localId-icon").removeClass('spinner');
                $("#node-lookup-localId").removeClass('disabled');
                $("#node-input-localId").autocomplete({
                    source:data,
                    minLength:0,
                    select: function(event, ui) {
                        $("#node-input-localId").val(ui.item.value);
                        $("#node-input-name").val(ui.item.label);
                        return false;
                    }
                }).autocomplete("search","");
            })
            .error(function(error) {
                $("#node-lookup-localId-icon").addClass('fa-search');
                $("#node-lookup-localId-icon").removeClass('spinner');
                $("#node-lookup-localId").removeClass('disabled');
                alert("Could not connected to gateway, check your gateway configuration!");
            });
    }
</script>

<script type="text/x-red" data-template-name="telldus-deviceinfo">
    <div class="form-row">
        <label for="node-input-gateway"><i class="fa fa-globe"></i> Gateway</label>
        <input type="text" id="node-input-gateway">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-localId"><i class="icon-tag"></i> Local Id</label>
        <input type="text" id="node-input-localId" placeholder="Local Id" style="width:60%">
        <a id="node-lookup-localId" class="btn"><i id="node-lookup-localId-icon" class="fa fa-search"></i></a>
    </div>
</script>

<script type="text/x-red" data-help-name="telldus-deviceinfo">
    <p>Retrieve A sensor node for on/off status information of door and motion sensors using the Telldus Local API in NodeRed</p>

    <h3>Input</h3>
    <p>Only used as trigger</p>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">JSON</span>
        </dt>
        <dd> A payload containing id, methods, model, name, protocol, state, statevalue, transport, type</dd>
    </dl>

    <h3>Access Token</h3>
    <p>To use this sensor node you need to authenticate and retreive an access token to use your Telldus device's Local API.
        You can either use the wizard that automates this process, but if you prefer to to it manually, you can follow the
        instructions in this <a href="http://api.telldus.net/localapi/api/authentication.html#step-1-request-a-request-token">Local API Authentication</a> reference.</p>

    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/perbrage/node-red-contrib-telldus-zwave-v2-local">GitHub Home</a> - github home for this node.</li>
        <li><a href="https://github.com/perbrage/node-red-contrib-telldus-zwave-v2-local/issues">GitHub Issues</a> - issue reporting for this node.</li>
        <li><a href="https://github.com/JakobPetersson/telldus-local">General NodeJS library</a> - the library this node is based on.</li>
    </ul>
</script>
